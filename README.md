# 荷塘AI - AI视频创作工具

基于 PyWebView + React 的桌面端AI视频创作工具，支持角色设计、镜头生成、配音制作等功能。

## 功能特性

- 🎭 **角色管理** - 创建和管理角色，生成3视图角色设计
- 🎬 **镜头制作** - 批量导入镜头脚本，生成图片和视频
- 🎵 **配音制作** - 为镜头生成配音，支持角色语音定制
- 📁 **项目管理** - 统一的项目目录管理，所有资源集中存储
- ⚙️ **API配置** - 支持多种AI服务配置（TTI、TTV、TTS）

## 项目管理模式

### 工作目录结构

程序默认使用 `~/Desktop/荷塘AI` 作为工作目录，所有项目都存储在此目录下：

```
~/Desktop/荷塘AI/
├── 项目A/
│   ├── project.json          # 项目配置文件
│   ├── 角色/                 # 角色图片目录
│   │   ├── char_abc123.jpg   # 角色3视图
│   │   └── char_def456.jpg
│   └── 镜头/                 # 镜头资源目录
│       ├── shot_a3f9k2_1.jpeg    # 镜头备选图1
│       ├── shot_a3f9k2_2.jpeg    # 镜头备选图2
│       ├── shot_a3f9k2_3.jpeg    # 镜头备选图3
│       ├── shot_a3f9k2_4.jpeg    # 镜头备选图4
│       ├── shot_a3f9k2_1.mp4     # 镜头备选视频1
│       ├── shot_a3f9k2_2.mp4     # 镜头备选视频2
│       ├── shot_a3f9k2_audio.wav # 镜头配音
│       └── ...
├── 项目B/
│   ├── project.json
│   └── ...
└── 项目C/
    ├── project.json
    └── ...
```

### 工作流程

1. **启动应用** - 程序启动后显示项目列表页面
2. **创建项目** - 点击"新建项目"创建新项目，自动切换到镜头编辑页面
3. **导入内容** - 通过Excel导入镜头脚本，或手动添加角色和镜头
4. **保存项目** - 项目会自动保存到工作目录，无需手动选择路径
5. **生成资源** - 生成的所有图片、视频、音频文件都存储在项目目录中
6. **项目管理** - 在项目列表页面查看、打开、管理所有项目

### 重要说明

- **必须先保存项目** - 在生成任何图片、视频或音频之前，必须先保存项目
- **统一存储** - 所有生成的资源文件都存储在项目目录中，不再使用临时目录
- **自动管理** - 项目目录结构由程序自动创建和管理
- **文件服务** - 内置HTTP文件服务器（端口8765）提供资源访问

## 技术架构

### 前端技术栈
- **React 18** - 用户界面框架
- **TypeScript** - 类型安全的JavaScript
- **Tailwind CSS** - 样式框架
- **Lucide React** - 图标库
- **Vite** - 构建工具
- **@tanstack/react-virtual** - 虚拟列表,优化大量镜头渲染性能

### 后端技术栈
- **Python 3.11+** - 主要开发语言
- **PyWebView** - 桌面应用框架
- **Loguru** - 日志管理
- **Peewee + SQLite** - 数据库（如需要）

### 项目结构
```
HeTangAI/
├── main.py                   # 应用入口
├── api.py                    # PyWebView API接口
├── services/                 # 业务服务
│   ├── project_manager.py    # 项目管理
│   ├── file_server.py        # 文件服务器
│   ├── generator.py          # AI生成服务
│   └── excel_parser.py       # Excel解析
├── web-src/                  # 前端源码
│   ├── src/
│   │   ├── components/       # React组件
│   │   ├── pages/           # 页面组件
│   │   ├── hooks/           # React Hooks
│   │   └── types.ts         # TypeScript类型定义
│   └── package.json
├── web/                      # 前端构建输出
├── logs/                     # 日志文件
└── icons/                    # 应用图标
```

## 开发环境

### 环境要求
- Python 3.11+
- Node.js 18+
- uv (Python包管理器)

### 开发模式
```bash
# 安装Python依赖
uv sync

# 安装前端依赖
cd web-src && npm install

# 启动开发模式
DEV=1 uv run python main.py
```

### 生产构建
```bash
# 构建前端
cd web-src && npm run build

# 启动生产模式
uv run python main.py
```

## API配置

在设置页面配置以下API服务：

### TTI (Text-to-Image) - 图片生成
- **API URL** - 图片生成服务地址
- **Model** - 使用的模型名称
- **API Key** - 服务认证密钥

### TTV (Text-to-Video) - 视频生成
- **API URL** - 视频生成服务地址
- **Model** - 使用的模型名称（支持I2V模式）
- **API Key** - 服务认证密钥

### TTS (Text-to-Speech) - 语音合成
- **API URL** - 语音合成服务地址
- **Model** - 使用的语音模型
- **API Key** - 服务认证密钥

## 使用指南

### 1. 创建项目
1. 启动应用，在项目列表页面点击"新建项目"
2. 程序会创建一个新项目并切换到镜头编辑页面
3. 修改项目名称并保存项目

### 2. 导入镜头
1. 点击"导入Excel"按钮选择镜头脚本文件
2. 或点击"导出模板"获取Excel模板格式
3. 导入后会自动创建对应的角色和镜头

### 3. 角色管理
1. 在角色页面添加或编辑角色信息
2. 为角色添加描述用于生成3视图
3. 点击"生成图片"为角色生成3视图设计
4. 可上传自定义角色图片

### 4. 镜头制作
1. 在镜头页面编辑镜头脚本和提示词
2. 点击"生成图片"为镜头生成4张备选图片
3. 选择满意的图片后点击"生成视频"生成备选视频
4. 为有台词的镜头生成配音
5. 可多次生成,系统保留最多4个备选图/视频供选择

## 实现方案

### 镜头ID与文件命名
- **镜头ID**: 6位随机字符(小写字母+数字),如`a3f9k2`
- **文件命名**: `shot_{id}_{index}.jpeg/mp4`,如`shot_a3f9k2_1.jpeg`
- **优势**: 避免插入镜头导致编号混乱,ID唯一且固定

### 备选图/视频管理
- **存储策略**: 每个镜头最多保留4个备选图和4个备选视频
- **槽位分配**: 优先填充空槽位(1-4),满了则替换最旧的
- **选择记录**: `selectedImageIndex`和`selectedVideoIndex`记录用户选择
- **默认选择**: 首次生成时自动选中第一个,重新生成时保持当前选择

### 项目文件结构
```json
{
  "shots": [{
    "id": "a3f9k2",
    "sequence": 1,
    "images": ["url1", "url2", "url3", "url4"],
    "selectedImageIndex": 0,
    "videos": ["url1", "url2"],
    "selectedVideoIndex": 0,
    "videoUrl": "当前选中的视频URL",
    "audioUrl": "配音URL"
  }]
}
```

### 5. 批量操作
- 选择多个镜头进行批量图片生成
- 批量视频生成（需要先有图片）
- 批量配音生成（需要有台词）

## 注意事项

1. **保存项目** - 在进行任何生成操作前必须先保存项目
2. **网络连接** - 需要稳定的网络连接访问AI服务
3. **存储空间** - 生成的视频文件较大，确保有足够存储空间
4. **API配额** - 注意AI服务的API调用配额限制
5. **文件权限** - 确保工作目录有读写权限

## 故障排除

### 常见问题

**Q: 生成失败提示"请先保存项目"**
A: 在生成任何资源前必须先保存项目，点击保存按钮或使用Ctrl+S

**Q: 项目列表为空**
A: 检查工作目录设置是否正确，默认为`~/Desktop/荷塘AI`

**Q: 生成的文件无法显示**
A: 检查文件服务器是否正常运行（端口8765），重启应用尝试

**Q: API调用失败**
A: 检查网络连接和API配置，确认API密钥和服务地址正确

### 日志查看
日志文件位于 `logs/` 目录下，按日期分割：
```bash
tail -f logs/app_2024-01-01.log
```

## 许可证

本项目采用 MIT 许可证。

## 更新日志

### v0.3.1 (2026-01-19)
- 镜头列表使用虚拟滚动优化性能,支持大量镜头流畅渲染

### v0.3.0 (2026-01-19)
- 镜头ID改用6位随机字符,避免插入导致编号混乱
- 支持每个镜头4个备选图和4个备选视频
- 优化生成逻辑,首次生成自动选中第一个
- 文件命名改为`shot_{id}_{index}`格式

### v0.2.0 (2024-01-19)
- 新增项目列表管理功能
- 统一文件存储到项目目录
- 优化项目保存流程
- 改进用户界面和导航逻辑

### v0.1.0 (2024-01-01)
- 初始版本发布
- 基础的角色和镜头管理功能
- AI图片、视频、配音生成
- Excel导入导出功能